name: Deploy to Ubuntu Server

on:
  push:
    branches:
      - 'main' # Deploy from main branch
  pull_request:
    branches:
      - 'main' # Build and test PRs targeting main
  workflow_dispatch: # Allows manual triggering

env:
  REGISTRY: ghcr.io
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/api/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ghcr.io/${{ github.repository_owner }}/goal-tracker-api:${{ github.sha }}
            ghcr.io/${{ github.repository_owner }}/goal-tracker-api:latest
          cache-from: type=registry,ref=ghcr.io/${{ github.repository_owner }}/goal-tracker-api:buildcache
          cache-to: type=registry,ref=ghcr.io/${{ github.repository_owner }}/goal-tracker-api:buildcache,mode=max

      - name: Replace Tailscale domain in nginx.conf
        run: |
          sed -i 's/TAILSCALE_DOMAIN/${{ secrets.TAILSCALE_DOMAIN }}/g' apps/web/nginx.conf

      - name: Build and push Web image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/web/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          build-args: |
            VITE_API_URL=${{ secrets.VITE_API_URL }}
          tags: |
            ghcr.io/${{ github.repository_owner }}/goal-tracker-web:${{ github.sha }}
            ghcr.io/${{ github.repository_owner }}/goal-tracker-web:latest
          cache-from: type=registry,ref=ghcr.io/${{ github.repository_owner }}/goal-tracker-web:buildcache
          cache-to: type=registry,ref=ghcr.io/${{ github.repository_owner }}/goal-tracker-web:buildcache,mode=max

  deploy:
    needs: build-and-push
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd ~/goal-tracker

            echo "üîë Logging into GitHub Container Registry..."
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            echo "üì• Pulling latest images..."
            docker pull ghcr.io/${{ github.repository_owner }}/goal-tracker-api:latest
            docker pull ghcr.io/${{ github.repository_owner }}/goal-tracker-web:latest

            echo "üõë Stopping old API and Web containers..."
            docker compose stop api web || true
            docker compose rm -f api web || true


            echo "ÔøΩüöÄ Starting all services..."
            docker compose up -d

            echo "üßπ Cleaning up old images..."
            docker image prune -f

            echo "‚úÖ Deployment completed successfully!"
            docker compose ps

      - name: Health check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "‚è≥ Waiting for services to be healthy..."
            sleep 15

            cd ~/goal-tracker

            # Check if containers are running
            if ! docker compose ps | grep -q "Up"; then
              echo "‚ùå Containers failed to start"
              docker compose logs --tail=50
              exit 1
            fi

            echo "‚úÖ Containers are running"
            docker compose ps

            # Check API health endpoint
            echo "üè• Checking API health..."
            max_attempts=30
            attempt=0
            while [ $attempt -lt $max_attempts ]; do
              # Check health from inside the container (bypasses HTTPS/cert issues)
              if docker exec goal-tracker-api curl -f http://localhost:3000/health > /dev/null 2>&1; then
                echo "‚úÖ API is healthy"
                exit 0
              fi
              attempt=$((attempt + 1))
              echo "Attempt $attempt/$max_attempts failed, retrying in 2s..."
              sleep 2
            done

            echo "‚ùå API health check failed after $max_attempts attempts"
            echo "Showing API logs:"
            docker compose logs api --tail=100
            echo ""
            echo "Container status:"
            docker compose ps api
            exit 1

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "‚úÖ Deployment successful!"
          else
            echo "‚ùå Deployment failed!"
          fi
