generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["relationJoins"]
}

datasource db {
  provider = "postgresql"
}

model User {
  id        Int      @id @default(autoincrement())
  sub       String   @unique
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  goals     Goal[]
  tasks     Task[]

  @@index([sub])
  @@index([email])
}

model Goal {
  id               String         @id @default(uuid())
  title            String
  description      String?
  type             GoalType
  targetValue      Float?
  currentValue     Float          @default(0)
  stepSize         Float          @default(1)
  frequencyTarget  Int?
  frequencyType    FrequencyType?
  startDate        DateTime       @default(now())
  endDate          DateTime?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  customDataLabel  String?
  parentId         String?
  scope            GoalScope      @default(STANDALONE)
  progressMode     ProgressMode   @default(TASK_BASED)
  isMarkedComplete Boolean        @default(false)
  userId           Int
  parent           Goal?          @relation("GoalHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children         Goal[]         @relation("GoalHierarchy")
  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  goalTasks        GoalTask[]
  progress         Progress[]

  @@index([userId])
}

model Task {
  id                        String        @id @default(uuid())
  title                     String
  description               String?
  size                      Int           @default(1)
  isCompleted               Boolean       @default(false)
  completedAt               DateTime?
  scheduledDate             DateTime?
  priority                  TaskPriority?
  category                  TaskCategory?
  scheduledTime             String?
  estimatedDurationMinutes  Int?
  estimatedCompletionDate   DateTime?
  parentTaskId              String?
  customData                String?
  createdAt                 DateTime      @default(now())
  updatedAt                 DateTime      @updatedAt
  userId                    Int
  goalTasks                 GoalTask[]
  parentTask                Task?         @relation("TaskHierarchy", fields: [parentTaskId], references: [id], onDelete: Cascade)
  subTasks                  Task[]        @relation("TaskHierarchy")
  user                      User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([scheduledDate, isCompleted])
  @@index([isCompleted])
}

model GoalTask {
  id        String   @id @default(uuid())
  goalId    String
  taskId    String
  createdAt DateTime @default(now())
  goal      Goal     @relation(fields: [goalId], references: [id], onDelete: Cascade)
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([goalId, taskId])
}

model Progress {
  id         String   @id @default(uuid())
  goalId     String
  value      Float
  date       DateTime @default(now())
  note       String?
  customData String?
  goal       Goal     @relation(fields: [goalId], references: [id], onDelete: Cascade)
}

enum GoalType {
  TOTAL_TARGET
  FREQUENCY
  HABIT
}

enum ProgressMode {
  TASK_BASED
  MANUAL_TOTAL
  HABIT
}

enum GoalScope {
  YEARLY
  MONTHLY
  WEEKLY
  STANDALONE
}

enum FrequencyType {
  DAILY
  WEEKLY
  MONTHLY
}

enum TaskPriority {
  HIGH
  MEDIUM
  LOW
}

enum TaskCategory {
  WORK
  PERSONAL
  HEALTH
  LEARNING
  FINANCE
  SOCIAL
  HOUSEHOLD
  OTHER
}
